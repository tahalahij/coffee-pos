// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  color       String   @default("#6B7280")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  products Product[]

  @@map("categories")
}

model Product {
  id            String   @id @default(uuid())
  name          String
  description   String?
  price         Decimal  @db.Decimal(10, 2)
  cost          Decimal? @db.Decimal(10, 2)
  sku           String?  @unique
  imageUrl      String?  @map("image_url")
  categoryId    String   @map("category_id")
  isAvailable   Boolean  @default(true) @map("is_available")
  stock         Int      @default(0)
  lowStockAlert Int?     @map("low_stock_alert")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  category       Category          @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  saleItems      SaleItem[]
  purchaseItems  PurchaseItem[]
  campaignItems  CampaignProduct[]

  @@map("products")
}

model Sale {
  id             String        @id @default(uuid())
  receiptNumber  String        @unique @map("receipt_number")
  customerId     String?       @map("customer_id")
  subtotal       Decimal       @db.Decimal(10, 2)
  taxAmount      Decimal       @default(0) @map("tax_amount") @db.Decimal(10, 2)
  discountAmount Decimal       @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalAmount    Decimal       @map("total_amount") @db.Decimal(10, 2)
  paymentMethod  PaymentMethod @map("payment_method")
  status         SaleStatus    @default(COMPLETED)
  cashReceived   Decimal?      @map("cash_received") @db.Decimal(10, 2)
  changeGiven    Decimal?      @map("change_given") @db.Decimal(10, 2)
  loyaltyPointsUsed Int        @default(0) @map("loyalty_points_used")
  loyaltyPointsEarned Int      @default(0) @map("loyalty_points_earned")
  campaignId     String?       @map("campaign_id")
  discountCodeId String?       @map("discount_code_id")
  notes          String?
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  customer     Customer?     @relation(fields: [customerId], references: [id])
  items        SaleItem[]
  campaign     Campaign?     @relation(fields: [campaignId], references: [id])
  discountCode DiscountCode? @relation(fields: [discountCodeId], references: [id])

  @@map("sales")
}

model SaleItem {
  id             String  @id @default(uuid())
  saleId         String  @map("sale_id")
  productId      String  @map("product_id")
  quantity       Int
  unitPrice      Decimal @map("unit_price") @db.Decimal(10, 2)
  discountAmount Decimal @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalAmount    Decimal @map("total_amount") @db.Decimal(10, 2)

  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("sale_items")
}

model Purchase {
  id              String         @id @default(uuid())
  supplierName    String         @map("supplier_name")
  supplierContact String?        @map("supplier_contact")
  totalAmount     Decimal        @map("total_amount") @db.Decimal(10, 2)
  status          PurchaseStatus @default(PENDING)
  notes           String?
  receivedAt      DateTime?      @map("received_at")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  items PurchaseItem[]

  @@map("purchases")
}

model PurchaseItem {
  id         String  @id @default(uuid())
  purchaseId String  @map("purchase_id")
  productId  String  @map("product_id")
  quantity   Int
  unitCost   Decimal @map("unit_cost") @db.Decimal(10, 2)
  totalCost  Decimal @map("total_cost") @db.Decimal(10, 2)

  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id])

  @@map("purchase_items")
}

// Enhanced Customer model with loyalty features
model Customer {
  id            String    @id @default(uuid())
  name          String
  phone         String    @unique
  email         String?   @unique
  dateOfBirth   DateTime? @map("date_of_birth")
  loyaltyPoints Int       @default(0) @map("loyalty_points")
  totalSpent    Decimal   @default(0) @map("total_spent") @db.Decimal(10, 2)
  visitCount    Int       @default(0) @map("visit_count")
  lastVisit     DateTime? @map("last_visit")
  loyaltyTier   LoyaltyTier @default(BRONZE) @map("loyalty_tier")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  sales              Sale[]
  discountCodes      DiscountCode[]
  loyaltyTransactions LoyaltyTransaction[]
  campaignParticipations CampaignParticipation[]

  @@map("customers")
}

// Loyalty Transaction tracking
model LoyaltyTransaction {
  id          String              @id @default(uuid())
  customerId  String              @map("customer_id")
  type        LoyaltyTransactionType
  points      Int
  description String?
  saleId      String?             @map("sale_id")
  createdAt   DateTime            @default(now()) @map("created_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("loyalty_transactions")
}

// Marketing Campaigns
model Campaign {
  id            String         @id @default(uuid())
  name          String
  description   String?
  type          CampaignType
  status        CampaignStatus @default(DRAFT)
  startDate     DateTime       @map("start_date")
  endDate       DateTime       @map("end_date")
  discountType  DiscountType   @map("discount_type")
  discountValue Decimal        @map("discount_value") @db.Decimal(10, 2)
  minPurchase   Decimal?       @map("min_purchase") @db.Decimal(10, 2)
  maxDiscount   Decimal?       @map("max_discount") @db.Decimal(10, 2)
  usageLimit    Int?           @map("usage_limit")
  usageCount    Int            @default(0) @map("usage_count")
  targetTier    LoyaltyTier?   @map("target_tier")
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  products       CampaignProduct[]
  participations CampaignParticipation[]
  sales          Sale[]

  @@map("campaigns")
}

// Campaign Product associations (for product-specific campaigns)
model CampaignProduct {
  id         String @id @default(uuid())
  campaignId String @map("campaign_id")
  productId  String @map("product_id")

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([campaignId, productId])
  @@map("campaign_products")
}

// Track customer participation in campaigns
model CampaignParticipation {
  id         String   @id @default(uuid())
  campaignId String   @map("campaign_id")
  customerId String   @map("customer_id")
  usageCount Int      @default(0) @map("usage_count")
  createdAt  DateTime @default(now()) @map("created_at")

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([campaignId, customerId])
  @@map("campaign_participations")
}

// Enhanced Discount Codes
model DiscountCode {
  id            String       @id @default(uuid())
  code          String       @unique
  name          String?
  description   String?
  type          DiscountType
  value         Decimal      @db.Decimal(10, 2)
  minPurchase   Decimal?     @map("min_purchase") @db.Decimal(10, 2)
  maxDiscount   Decimal?     @map("max_discount") @db.Decimal(10, 2)
  usageLimit    Int?         @map("usage_limit")
  usageCount    Int          @default(0) @map("usage_count")
  customerId    String?      @map("customer_id")
  expiresAt     DateTime?    @map("expires_at")
  isActive      Boolean      @default(true) @map("is_active")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  customer Customer? @relation(fields: [customerId], references: [id])
  sales    Sale[]

  @@map("discount_codes")
}

// Notification system for marketing
model Notification {
  id         String             @id @default(uuid())
  customerId String?            @map("customer_id")
  title      String
  message    String
  type       NotificationType
  isRead     Boolean            @default(false) @map("is_read")
  scheduledAt DateTime?         @map("scheduled_at")
  sentAt     DateTime?          @map("sent_at")
  createdAt  DateTime           @default(now()) @map("created_at")

  @@map("notifications")
}

// Enums
enum PaymentMethod {
  CASH
  CARD
  DIGITAL
}

enum SaleStatus {
  PENDING
  COMPLETED
  REFUNDED
  CANCELLED
}

enum PurchaseStatus {
  PENDING
  RECEIVED
  CANCELLED
}

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum LoyaltyTransactionType {
  EARNED
  REDEEMED
  EXPIRED
  BONUS
  ADJUSTMENT
}

enum CampaignType {
  PERCENTAGE_DISCOUNT
  FIXED_DISCOUNT
  BUY_ONE_GET_ONE
  LOYALTY_BONUS
  BIRTHDAY_SPECIAL
  SEASONAL
  NEW_CUSTOMER
  RETURN_CUSTOMER
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum NotificationType {
  CAMPAIGN
  LOYALTY_REWARD
  BIRTHDAY
  LOW_POINTS
  SPECIAL_OFFER
  GENERAL
}
